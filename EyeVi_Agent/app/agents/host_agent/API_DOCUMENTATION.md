# üöÄ **HOST AGENT API DOCUMENTATION**

## **‚ö° Quick Reference**

### **Base URL**
```
http://localhost:8080
```

### **Main Endpoints**
```bash
# Chat (main endpoint)
POST /chat
curl -X POST "http://localhost:8080/chat" -F "message=Hello"

# With files
curl -X POST "http://localhost:8080/chat" \
  -F "message=Analyze this" -F "files=@image.jpg" -F "user_id=123"

# Health check
GET /health

# Agent status  
GET /agents/status

# Session management
POST /sessions/create
GET /sessions
GET /users/{user_id}/sessions

# Chat history
GET /sessions/{session_id}/history?user_id={user_id}
DELETE /sessions/{session_id}/history?user_id={user_id}
```

### **Required Environment**
```env
GOOGLE_API_KEY=your_google_api_key
```

### **Response Format**
```json
{
  "response": "AI response text",
  "agent_used": "Search Agent",
  "session_id": "abc-def-ghi",
  "status": "success",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

---

## **üìã Overview**

Host Agent l√† orchestrator API ƒë·ªÉ ƒëi·ªÅu ph·ªëi messages t·ªõi c√°c specialized agents (Advisor, Search, Order) trong h·ªá th·ªëng multi-agent. API h·ªó tr·ª£ chat v·ªõi text, files, v√† real-time message logging v√†o MySQL.

**Base URL**: `http://localhost:8080`  
**Version**: `1.0.0`  
**Content Type**: `application/json` ho·∫∑c `multipart/form-data`

---

## **üèóÔ∏è Architecture**

```
User Request ‚Üí Host Agent ‚Üí [Orchestrator LLM] ‚Üí Selected Agent ‚Üí Response
                ‚Üì
        [Redis + LangChain Memory]
                ‚Üì
           [MySQL Logging]
```

### **Key Features**
- ‚úÖ **Message Orchestration**: T·ª± ƒë·ªông ph√¢n t√≠ch v√† route t·ªõi agent ph√π h·ª£p
- ‚úÖ **Multi-modal Support**: Text + files (images, documents)
- ‚úÖ **Memory Management**: Redis + LangChain + MySQL triple storage
- ‚úÖ **Real-time Logging**: M·ªói message t·ª± ƒë·ªông save v√†o MySQL
- ‚úÖ **Session Management**: Support cho long conversations
- ‚úÖ **Agent Health Monitoring**: Real-time status checking

---

## **üìä Data Models**

### **ChatResponse**
```json
{
  "response": "string",
  "agent_used": "string | null",
  "session_id": "string",
  "clarified_message": "string | null",
  "analysis": "string | null", 
  "data": "object | null",
  "status": "success",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

### **HealthResponse**
```json
{
  "status": "healthy | unhealthy",
  "message": "string",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

### **FileInfo** (Internal)
```json
{
  "name": "filename.jpg",
  "mime_type": "image/jpeg",
  "data": "base64_encoded_content"
}
```

---

## **üîó API Endpoints**

### **1. Health Check**

#### `GET /`
**Description**: Basic health check endpoint

**Response**: `200 OK`
```json
{
  "status": "healthy",
  "message": "Host Agent Server ƒëang ho·∫°t ƒë·ªông t·ªët!",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

#### `GET /health`
**Description**: Detailed health check v·ªõi agent status

**Response**: `200 OK`
```json
{
  "status": "healthy", 
  "message": "T·∫•t c·∫£ services ho·∫°t ƒë·ªông t·ªët. Agents: {...}",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

**Error Response**: `500 Internal Server Error`
```json
{
  "detail": "Health check failed: connection error"
}
```

---

### **2. Chat Endpoint**

#### `POST /chat`
**Description**: Main endpoint ƒë·ªÉ chat v·ªõi system (text + files)

**Content-Type**: `multipart/form-data`

**Request Parameters**:
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `message` | string | ‚úÖ | N·ªôi dung tin nh·∫Øn t·ª´ user |
| `user_id` | string | ‚ùå | ID ng∆∞·ªùi d√πng (ƒë·ªÉ track history) |
| `session_id` | string | ‚ùå | ID phi√™n chat (auto-generate n·∫øu null) |
| `files` | List[UploadFile] | ‚ùå | Files ƒë√≠nh k√®m (images, docs) |

**Request Example** (with files):
```bash
curl -X POST "http://localhost:8080/chat" \
  -F "message=T√¥i mu·ªën t√¨m s·∫£n ph·∫©m n√†y" \
  -F "user_id=123" \
  -F "session_id=abc-def-ghi" \
  -F "files=@product_image.jpg"
```

**Request Example** (text only):
```bash
curl -X POST "http://localhost:8080/chat" \
  -F "message=Ch√†o b·∫°n, t√¥i c·∫ßn t∆∞ v·∫•n v·ªÅ s·∫£n ph·∫©m" \
  -F "user_id=123"
```

**Response**: `200 OK`
```json
{
  "response": "Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m hi·ªÉu v·ªÅ c√°c s·∫£n ph·∫©m...",
  "agent_used": "Advisor Agent",
  "session_id": "abc-def-ghi-jkl",
  "clarified_message": "T√¥i mu·ªën t√¨m hi·ªÉu v·ªÅ s·∫£n ph·∫©m iPhone 15 Pro Max",
  "analysis": "User ƒëang t√¨m ki·∫øm th√¥ng tin s·∫£n ph·∫©m Apple",
  "data": {
    "product_ids": [123, 456],
    "category": "electronics"
  },
  "status": "success",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

**Error Response**: `500 Internal Server Error`
```json
{
  "detail": "L·ªói khi x·ª≠ l√Ω message: connection timeout"
}
```

---

### **3. Agent Management**

#### `GET /agents/status`
**Description**: Ki·ªÉm tra tr·∫°ng th√°i t·∫•t c·∫£ agents

**Response**: `200 OK`
```json
{
  "status": "success",
  "agents": {
    "Advisor Agent": {
      "healthy": true,
      "url": "http://localhost:10001",
      "response_time": 0.15
    },
    "Search Agent": {
      "healthy": true, 
      "url": "http://localhost:10002",
      "response_time": 0.23
    },
    "Order Agent": {
      "healthy": false,
      "url": "http://localhost:10003", 
      "error": "Connection refused"
    }
  },
  "timestamp": "2024-01-15T10:30:00Z"
}
```

---

### **4. Session Management**

#### `POST /sessions/create`
**Description**: T·∫°o session ID m·ªõi

**Response**: `200 OK`
```json
{
  "status": "success",
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "message": "Session m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

#### `GET /sessions`
**Description**: Li·ªát k√™ t·∫•t c·∫£ active sessions

**Response**: `200 OK`
```json
{
  "status": "success",
  "active_sessions": 5,
  "sessions": [
    {
      "session_id": "abc-def-ghi",
      "created_at": "2024-01-15T10:00:00Z",
      "last_updated": "2024-01-15T10:25:00Z",
      "message_count": 12,
      "last_message_preview": "C·∫£m ∆°n b·∫°n ƒë√£ h·ªó tr·ª£ t√¥i..."
    }
  ],
  "timestamp": "2024-01-15T10:30:00Z"
}
```

#### `GET /users/{user_id}/sessions`
**Description**: L·∫•y t·∫•t c·∫£ sessions c·ªßa user c·ª• th·ªÉ

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `user_id` | string | ID c·ªßa user |

**Response**: `200 OK`
```json
{
  "status": "success",
  "user_id": "123",
  "total_sessions": 3,
  "sessions": [
    {
      "session_id": "abc-def-ghi",
      "created_at": "2024-01-15T10:00:00Z",
      "last_updated": "2024-01-15T10:25:00Z", 
      "message_count": 12,
      "last_message_preview": "T√¥i mu·ªën mua s·∫£n ph·∫©m..."
    }
  ],
  "timestamp": "2024-01-15T10:30:00Z"
}
```

---

### **5. Chat History**

#### `GET /sessions/{session_id}/history`
**Description**: L·∫•y l·ªãch s·ª≠ chat cho session

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `session_id` | string | ID c·ªßa session |

**Query Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `user_id` | string | ID c·ªßa user (optional) |

**Response**: `200 OK`
```json
{
  "status": "success",
  "session_id": "abc-def-ghi",
  "user_id": "123",
  "messages": [
    {
      "role": "user",
      "content": "Ch√†o b·∫°n",
      "timestamp": "2024-01-15T10:00:00Z",
      "clarified_content": null
    },
    {
      "role": "assistant", 
      "content": "Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?",
      "timestamp": "2024-01-15T10:00:05Z",
      "agent_used": "Host Agent"
    }
  ],
  "created_at": "2024-01-15T10:00:00Z",
  "last_updated": "2024-01-15T10:25:00Z",
  "total_messages": 12
}
```

**Empty Response**: `200 OK`
```json
{
  "status": "success",
  "session_id": "abc-def-ghi", 
  "user_id": "123",
  "messages": [],
  "message": "Kh√¥ng c√≥ l·ªãch s·ª≠ chat cho session n√†y"
}
```

#### `DELETE /sessions/{session_id}/history`
**Description**: X√≥a l·ªãch s·ª≠ chat cho session

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `session_id` | string | ID c·ªßa session |

**Query Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `user_id` | string | ID c·ªßa user (optional) |

**Response**: `200 OK`
```json
{
  "status": "success",
  "session_id": "abc-def-ghi",
  "user_id": "123",
  "message": "ƒê√£ x√≥a l·ªãch s·ª≠ chat th√†nh c√¥ng",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

---

## **üíæ MySQL Real-time Logging**

### **Database Schema**
```sql
CREATE TABLE message_history (
    id              BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    session_id      VARCHAR(255) NOT NULL,
    user_id         BIGINT UNSIGNED NULL,
    sender_type     ENUM('user', 'host_agent', 'advisor_agent', 'search_agent', 'order_agent'),
    message_content TEXT NOT NULL,
    metadata        JSON NULL,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### **Metadata Examples**
```json
{
  "clarified_content": "T√¥i mu·ªën mua iPhone 15 Pro Max",
  "files": ["product_image.jpg", "specs.pdf"],
  "agent_name": "Search Agent",
  "response_data": {
    "product_ids": [123, 456],
    "search_results": [...]
  },
  "analysis": "User ƒëang t√¨m ki·∫øm s·∫£n ph·∫©m Apple c·ª• th·ªÉ"
}
```

### **Automatic Logging**
- ‚úÖ **M·ªói message** t·ª± ƒë·ªông save v√†o MySQL real-time
- ‚úÖ **Rich metadata** including files, agent info, analysis
- ‚úÖ **Graceful fallback** n·∫øu MySQL down (kh√¥ng block chat)
- ‚úÖ **Performance optimized** v·ªõi connection pooling

---

## **üîß Configuration**

### **Environment Variables**
```env
# Server
HOST=0.0.0.0
PORT=8080

# Google AI
GOOGLE_API_KEY=your_google_api_key

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# MySQL (New!)
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=chat_db

# Agent URLs
ADVISOR_AGENT_URL=http://localhost:10001
SEARCH_AGENT_URL=http://localhost:10002
ORDER_AGENT_URL=http://localhost:10003
```

---

## **‚ö†Ô∏è Error Handling**

### **Common HTTP Status Codes**
| Code | Description | Example |
|------|-------------|---------|
| `200` | Success | Request processed successfully |
| `400` | Bad Request | Invalid parameters |
| `500` | Server Error | Internal processing error |

### **Error Response Format**
```json
{
  "detail": "Descriptive error message"
}
```

### **Common Errors**
- **Agent Unavailable**: System s·∫Ω fallback v·ªÅ Host Agent
- **MySQL Down**: Messages v·∫´n save v√†o Redis/LangChain
- **Invalid File Format**: Files kh√¥ng ƒë∆∞·ª£c support s·∫Ω b·ªã skip
- **Session Not Found**: T·ª± ƒë·ªông t·∫°o session m·ªõi

---

## **üöÄ Testing Examples**

### **Complete Test Flow**
```bash
# 1. Health check
curl -X GET "http://localhost:8080/health"

# 2. Create new session
curl -X POST "http://localhost:8080/sessions/create"

# 3. Simple chat
curl -X POST "http://localhost:8080/chat" \
  -F "message=Ch√†o b·∫°n, t√¥i c·∫ßn t∆∞ v·∫•n"

# 4. Chat with user ID v√† session ID
curl -X POST "http://localhost:8080/chat" \
  -F "message=T√¥i mu·ªën t√¨m iPhone 15 Pro Max" \
  -F "user_id=123" \
  -F "session_id=test-session-abc"

# 5. Continue conversation
curl -X POST "http://localhost:8080/chat" \
  -F "message=C√≤n m√†u n√†o kh√°c?" \
  -F "user_id=123" \
  -F "session_id=test-session-abc"

# 6. Chat with file upload
curl -X POST "http://localhost:8080/chat" \
  -F "message=Ph√¢n t√≠ch s·∫£n ph·∫©m trong h√¨nh n√†y" \
  -F "user_id=123" \
  -F "session_id=test-session-abc" \
  -F "files=@product_image.jpg"

# 7. Check chat history
curl -X GET "http://localhost:8080/sessions/test-session-abc/history?user_id=123"

# 8. Check agent status
curl -X GET "http://localhost:8080/agents/status"

# 9. List user sessions
curl -X GET "http://localhost:8080/users/123/sessions"

# 10. Clear chat history
curl -X DELETE "http://localhost:8080/sessions/test-session-abc/history?user_id=123"
```

### **Python Testing Script**
```python
import requests
import json

BASE_URL = "http://localhost:8080"

def test_host_agent():
    # 1. Health check
    response = requests.get(f"{BASE_URL}/health")
    print(f"Health: {response.json()}")
    
    # 2. Create session
    response = requests.post(f"{BASE_URL}/sessions/create")
    session_id = response.json()["session_id"]
    print(f"Session ID: {session_id}")
    
    # 3. Chat
    data = {
        "message": "T√¥i c·∫ßn t∆∞ v·∫•n v·ªÅ k√≠nh c·∫≠n th·ªã",
        "user_id": "123",
        "session_id": session_id
    }
    response = requests.post(f"{BASE_URL}/chat", data=data)
    print(f"Chat Response: {response.json()}")
    
    # 4. Check history
    response = requests.get(f"{BASE_URL}/sessions/{session_id}/history?user_id=123")
    print(f"History: {response.json()}")

if __name__ == "__main__":
    test_host_agent()
```

### **JavaScript/Fetch Testing**
```javascript
const BASE_URL = 'http://localhost:8080';

async function testHostAgent() {
    try {
        // 1. Health check
        const healthResponse = await fetch(`${BASE_URL}/health`);
        console.log('Health:', await healthResponse.json());
        
        // 2. Create session
        const sessionResponse = await fetch(`${BASE_URL}/sessions/create`, {
            method: 'POST'
        });
        const sessionData = await sessionResponse.json();
        const sessionId = sessionData.session_id;
        
        // 3. Chat with FormData
        const formData = new FormData();
        formData.append('message', 'Ch√†o b·∫°n, t√¥i c·∫ßn h·ªó tr·ª£');
        formData.append('user_id', '123');
        formData.append('session_id', sessionId);
        
        const chatResponse = await fetch(`${BASE_URL}/chat`, {
            method: 'POST',
            body: formData
        });
        console.log('Chat:', await chatResponse.json());
        
    } catch (error) {
        console.error('Test failed:', error);
    }
}

testHostAgent();
```

---

## **üìä Monitoring & Analytics**

### **MySQL Queries for Analytics**
```sql
-- Daily message stats
SELECT DATE(created_at) as date, 
       sender_type, 
       COUNT(*) as message_count
FROM message_history 
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(created_at), sender_type;

-- Top active sessions
SELECT session_id, 
       COUNT(*) as messages,
       MAX(created_at) as last_activity
FROM message_history 
GROUP BY session_id 
ORDER BY messages DESC 
LIMIT 10;

-- Agent usage distribution  
SELECT sender_type, 
       COUNT(*) as usage_count,
       ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM message_history), 2) as percentage
FROM message_history 
WHERE sender_type != 'user'
GROUP BY sender_type;
```

---

## **üîí Security Considerations**

- ‚úÖ **Input Validation**: T·∫•t c·∫£ inputs ƒë∆∞·ª£c validate
- ‚úÖ **File Size Limits**: Files ƒë∆∞·ª£c gi·ªõi h·∫°n k√≠ch th∆∞·ªõc
- ‚úÖ **SQL Injection Protection**: S·ª≠ d·ª•ng parameterized queries
- ‚úÖ **Error Information**: Kh√¥ng expose sensitive data trong errors
- ‚ö†Ô∏è **Authentication**: Ch∆∞a implement (future feature)

---

## **üöß Roadmap**

### **Planned Features**
- üîê **Authentication & Authorization** 
- üìà **Advanced Analytics Dashboard**
- üîÑ **Webhook Support** for real-time updates
- üì± **WebSocket Support** for real-time chat
- üóÇÔ∏è **File Storage Integration** (S3, CloudFlare)
- üîç **Full-text Search** trong chat history

---

## **üîó Additional Resources**

### **Complete Setup Guide**
Xem [README.md](README.md) cho:
- Installation instructions
- Environment configuration  
- MySQL database setup
- Development guidelines

### **Source Code Structure**
```
host_agent/
‚îú‚îÄ‚îÄ main.py                 # FastAPI server
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îú‚îÄ‚îÄ host_server.py      # Core orchestration logic
‚îÇ   ‚îú‚îÄ‚îÄ a2a_client_manager.py # Agent communication
‚îÇ   ‚îú‚îÄ‚îÄ mysql_message_history.py # Real-time logging
‚îÇ   ‚îî‚îÄ‚îÄ langchain_memory_adapter.py # Memory management
‚îú‚îÄ‚îÄ prompt/
‚îÇ   ‚îî‚îÄ‚îÄ root_prompt.py      # Orchestrator prompts
‚îî‚îÄ‚îÄ client/
    ‚îî‚îÄ‚îÄ test_client.py      # Testing utilities
```

---

**üìû Support**: Li√™n h·ªá development team n·∫øu c√≥ v·∫•n ƒë·ªÅ k·ªπ thu·∫≠t  
**üìã Version**: 1.0.0  
**üîÑ Last Updated**: January 2024 